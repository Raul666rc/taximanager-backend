<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxiManager V3</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <link rel="stylesheet" href="css/styles.css">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png"> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('Error SW:', err));
            });
        }
    </script>
</head>
<body class="bg-black text-white">

    <section id="zona-operativa" class="seccion-full-screen container-fluid p-3">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="text-white small fw-bold">
                <i class="fas fa-taxi text-warning"></i> TaxiManager
            </div>
            <button class="btn btn-sm btn-dark border-secondary position-relative" onclick="document.getElementById('zona-administrativa').scrollIntoView()">
                <i class="fas fa-wallet text-warning"></i>
                <span id="badgeDeudasCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none">0</span>
            </button>
        </div>

        <div class="flex-grow-1 d-flex flex-column justify-content-center align-items-center gap-3">
            
            <div id="txtCronometro" class="h5 text-white-50 text-center mb-2">
                Esperando carrera...
            </div>

            <button id="btnIniciar" class="btn btn-success btn-circle-xl animate__animated animate__pulse animate__infinite" onclick="iniciarCarrera()">
                <i class="fas fa-power-off fa-3x mb-2"></i>
                <span class="fw-bold">INICIAR</span>
            </button>

            <div id="panelEnCarrera" class="d-none w-100 px-3">
                <div class="d-grid gap-3">
                    <button class="btn btn-warning btn-lg fw-bold py-4 shadow" onclick="registrarParada()">
                        <i class="fas fa-map-pin fa-lg me-2"></i> REGISTRAR PARADA
                    </button>
                    <button class="btn btn-danger btn-lg fw-bold py-4 shadow" data-bs-toggle="modal" data-bs-target="#modalCobrar">
                        <i class="fas fa-flag-checkered fa-lg me-2"></i> FINALIZAR VIAJE
                    </button>
                    <div class="row g-2 mt-1">
                        <div class="col-6">
                             <a href="waze://" class="btn btn-dark border-secondary w-100 py-2"><i class="fab fa-waze text-info me-2"></i>Waze</a>
                        </div>
                        <div class="col-6">
                             <a href="https://maps.google.com" target="_blank" class="btn btn-dark border-secondary w-100 py-2"><i class="fas fa-map-marked-alt text-danger me-2"></i>Maps</a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="selectorApps" class="btn-group w-100 mt-4 px-3" role="group">
                <input type="radio" class="btn-check" name="appOrigen" id="appCalle" value="CALLE" checked>
                <label class="btn btn-outline-warning py-3" for="appCalle"><i class="fas fa-hand-paper fa-lg mb-1"></i><br>Calle</label>

                <input type="radio" class="btn-check" name="appOrigen" id="appIndriver" value="INDRIVER">
                <label class="btn btn-outline-success py-3" for="appIndriver"><i class="fas fa-car-side fa-lg mb-1"></i><br>InDrive</label>

                <input type="radio" class="btn-check" name="appOrigen" id="appUber" value="UBER">
                <label class="btn btn-outline-light py-3" for="appUber"><i class="fab fa-uber fa-lg mb-1"></i><br>Uber</label>
            </div>

        </div>

        <div class="mt-4 px-3">
            <button class="btn btn-outline-danger w-100 py-3 border-dashed" data-bs-toggle="modal" data-bs-target="#modalGastoRapido">
                <i class="fas fa-gas-pump me-2"></i> Gasto R√°pido / Gasolina
            </button>
        </div>

        <div class="flecha-bajar text-white-50" onclick="document.getElementById('zona-administrativa').scrollIntoView()">
            <small>Ver Oficina</small><br>
            <i class="fas fa-chevron-down"></i>
        </div>

    </section>


    <section id="zona-administrativa" class="container pb-5" style="background-color: #1a1d20; min-height: 100vh; padding-top: 20px;">
        
        <div class="d-flex justify-content-between align-items-center border-bottom border-secondary pb-3 mb-4">
            <h4 class="text-white fw-bold m-0"><i class="fas fa-chart-line text-info me-2"></i>Mi Oficina</h4>
            <button class="btn btn-sm btn-outline-danger" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i> Salir
            </button>
        </div>

        <div class="card border-0 shadow-lg mb-4" 
             style="background: linear-gradient(135deg, #1a1a1a 0%, #2d3436 100%); cursor: pointer;" 
             onclick="cambiarMeta()">
            <div class="card-body p-4 position-relative overflow-hidden">
                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255, 193, 7, 0.1); border-radius: 50%;"></div>
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="text-muted text-uppercase small"><i class="fas fa-tachometer-alt me-1 text-warning"></i> Meta Diaria</div>
                    <div class="badge bg-dark border border-secondary text-warning" id="lblPorcentaje">0%</div>
                </div>
                <h1 class="display-2 fw-bold text-white mb-0">
                    <span class="fs-4 text-secondary align-middle">S/</span><span id="lblTotalDia">0.00</span>
                </h1>
                <div class="progress mt-3 bg-black" style="height: 8px; border-radius: 4px;">
                    <div id="barraMeta" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-secondary" id="lblMetaNum">Meta: S/ 200</small>
                    <small class="text-white fst-italic fw-bold" id="lblFrase">...</small>
                </div>
            </div>
        </div>

        <div class="row g-2 mb-4">
            <div class="col-4">
                <button class="btn btn-dark border-secondary w-100 py-3" onclick="abrirBilletera()">
                    <i class="fas fa-wallet text-warning fa-lg mb-2"></i><br><small>Billetera</small>
                </button>
            </div>
            <div class="col-4">
                <button class="btn btn-dark border-secondary w-100 py-3" onclick="abrirEstadisticas()">
                    <i class="fas fa-chart-pie text-info fa-lg mb-2"></i><br><small>Gr√°ficos</small>
                </button>
            </div>
            <div class="col-4">
                <button class="btn btn-dark border-secondary w-100 py-3" onclick="abrirCierreCaja()">
                    <i class="fas fa-cash-register text-success fa-lg mb-2"></i><br><small>Cierre</small>
                </button>
            </div>
        </div>

        <div class="card bg-dark text-white border-secondary mb-4 shadow">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center py-2">
                <h6 class="mb-0 text-white"><i class="fas fa-car me-2"></i>Mi Auto</h6>
                <button class="btn btn-sm btn-outline-light py-0" onclick="configurarAuto()"><i class="fas fa-cog"></i></button>
            </div>
            <div class="card-body p-3">
                <div class="text-center mb-2">
                    <span class="text-muted small">OD√ìMETRO:</span> 
                    <span id="lblOdometro" class="fw-bold fs-4 text-white ms-2">0</span> <span class="small text-muted">km</span>
                </div>
                <div class="position-relative mb-2">
                    <div class="progress bg-black" style="height: 20px;">
                        <div id="barraAceite" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                    </div>
                    <div class="position-absolute top-0 start-0 w-100 text-center text-white fw-bold small" style="line-height: 20px;">
                        Vida Aceite: <span id="lblPorcentajeAceite">100%</span>
                    </div>
                </div>
                <div id="lblAlertaAceite" class="alert alert-danger p-1 text-center small fw-bold mt-2" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-1"></i> CAMBIO URGENTE
                </div>
                <div class="d-flex justify-content-between mt-3 gap-1">
                    <div class="d-flex flex-column align-items-center bg-black bg-opacity-25 p-2 rounded flex-fill">
                        <small class="text-muted" style="font-size:0.65rem;">SOAT</small>
                        <span class="badge bg-secondary rounded-pill" id="badgeSoat">...</span>
                        <small class="text-white-50" style="font-size:0.6rem;" id="fechaSoat">--/--</small>
                    </div>
                    <div class="d-flex flex-column align-items-center bg-black bg-opacity-25 p-2 rounded flex-fill">
                        <small class="text-muted" style="font-size:0.65rem;">REV</small>
                        <span class="badge bg-secondary rounded-pill" id="badgeRevision">...</span>
                        <small class="text-white-50" style="font-size:0.6rem;" id="fechaRevision">--/--</small>
                    </div>
                    <div class="d-flex flex-column align-items-center bg-black bg-opacity-25 p-2 rounded flex-fill">
                        <small class="text-muted" style="font-size:0.65rem;">GNV</small>
                        <span class="badge bg-secondary rounded-pill" id="badgeGnv">...</span>
                        <small class="text-white-50" style="font-size:0.6rem;" id="fechaGnv">--/--</small>
                    </div>
                </div>
                <div class="d-grid mt-2">
                    <button class="btn btn-sm btn-dark border-secondary text-muted" data-bs-toggle="modal" data-bs-target="#modalDetalleMantenimiento">
                        <i class="fas fa-list-ul me-2"></i> Ver Detalles Mantenimiento
                    </button>
                </div>
            </div>
        </div>

        <div class="card bg-dark text-white border-danger mb-4 shadow">
            <div class="card-header border-danger d-flex justify-content-between align-items-center py-2 bg-danger bg-opacity-10">
                <span class="text-danger fw-bold"><i class="fas fa-crosshairs me-2"></i>Objetivos</span>
                <button class="btn btn-sm btn-outline-danger py-0" onclick="cargarControlMetas()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="card-body" id="contenedorMetas">
                <div class="text-center text-muted small py-3">Cargando...</div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center border-bottom border-secondary pb-2 mb-3">
                    <h6 class="text-muted m-0"><i class="fas fa-history me-2"></i>Historial</h6>
                    <button class="btn btn-sm btn-outline-secondary py-0" onclick="cargarMovimientos()"><i class="fas fa-sync"></i></button>
                </div>
                
                <button class="btn btn-outline-danger w-100 py-3 border-dashed mb-3" data-bs-toggle="modal" data-bs-target="#modalGasto">
                    <i class="fas fa-minus-circle me-2"></i> Registrar Otro Gasto
                </button>

                <input type="date" id="filtroFechaHistorial" class="form-control form-control-sm bg-dark text-white border-secondary mb-3" onchange="cargarHistorial()">
                <div id="listaHistorial" class="d-grid gap-2"></div>
                <div id="msgVacio" class="text-center text-muted mt-3 d-none"><small>No hay carreras hoy.</small></div>
                
                <h6 class="text-muted border-bottom border-secondary pb-2 mb-3 mt-4">
                    <i class="fas fa-list-ul me-2"></i>√öltimos Movimientos
                </h6>
                <div id="listaMovimientosHome" class="list-group list-group-flush">
                    <div class="text-center py-4 text-muted">Cargando...</div>
                </div>
            </div>
        </div>

        <div style="height: 100px;"></div>

    </section>


    <div class="modal fade" id="modalCobrar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Finalizar Carrera</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label text-muted small">Monto Total (S/.)</label>
                    <input type="number" class="form-control form-control-lg mb-4 bg-black text-white border-success fw-bold text-center" placeholder="0.00">
                    <label class="form-label text-muted small">M√©todo de Pago</label>
                    <div class="btn-group w-100 mb-3" role="group">
                        <input type="radio" class="btn-check" name="pago" id="pago1" checked>
                        <label class="btn btn-outline-success py-3" for="pago1"><i class="fas fa-money-bill-wave"></i> Efectivo</label>
                        <input type="radio" class="btn-check" name="pago" id="pago2">
                        <label class="btn btn-outline-warning py-3" for="pago2"><i class="fas fa-qrcode"></i> Yape / Plin</label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-success w-100 btn-lg fw-bold" onclick="guardarCarrera()">
                        <i class="fas fa-check-circle me-2"></i> REGISTRAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGasto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-danger">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger"><i class="fas fa-minus-circle me-2"></i>Registrar Salida</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-white-50 small">Categor√≠a:</label>
                        <div class="row g-2" id="selectorCategoria">
                            <div class="col-4">
                                <input type="radio" class="btn-check" name="catGasto" id="catCombustible" value="Combustible" checked>
                                <label class="btn btn-outline-secondary w-100 py-2" for="catCombustible"><i class="fas fa-gas-pump text-danger"></i><br>GLP</label>
                            </div>
                            <div class="col-4">
                                <input type="radio" class="btn-check" name="catGasto" id="catAlimentos" value="Alimentos">
                                <label class="btn btn-outline-secondary w-100 py-2" for="catAlimentos"><i class="fas fa-utensils text-warning"></i><br>Men√∫</label>
                            </div>
                            <div class="col-4">
                                <input type="radio" class="btn-check" name="catGasto" id="catMantenimiento" value="Mantenimiento">
                                <label class="btn btn-outline-secondary w-100 py-2" for="catMantenimiento"><i class="fas fa-tools text-info"></i><br>Taller</label>
                            </div>
                            <div class="col-4">
                                <input type="radio" class="btn-check" name="catGasto" id="catLimpieza" value="Limpieza">
                                <label class="btn btn-outline-secondary w-100 py-2" for="catLimpieza"><i class="fas fa-soap text-primary"></i><br>Lavado</label>
                            </div>
                            <div class="col-8">
                                <input type="radio" class="btn-check" name="catGasto" id="catOtros" value="Otros">
                                <label class="btn btn-outline-secondary w-100 py-2" for="catOtros"><i class="fas fa-ellipsis-h"></i> Otros</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control bg-dark text-white border-secondary fw-bold" id="montoGasto" placeholder="0.00">
                        <label for="montoGasto" class="text-muted">Monto (S/)</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="descGasto" placeholder="Ej: Almuerzo">
                        <label for="descGasto" class="text-muted">Detalle (Opcional)</label>
                    </div>
                    <select class="form-select bg-dark text-white border-secondary" id="cuentaGasto">
                        <option value="1">üíµ Efectivo (Bolsillo)</option>
                        <option value="2">üì± Yape / Plin</option>
                    </select>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-danger fw-bold w-100" onclick="guardarGasto()">REGISTRAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGastoRapido" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-white border-danger shadow">
                <div class="modal-header border-secondary pb-2">
                    <h5 class="modal-title text-danger fw-bold"><i class="fa-solid fa-bolt me-2"></i>Gasto R√°pido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group input-group-lg mb-3">
                        <span class="input-group-text bg-black text-danger border-secondary">S/</span>
                        <input type="number" id="montoGastoRapido" class="form-control bg-black text-white border-secondary fw-bold text-center fs-2" placeholder="0.00">
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="radio" class="btn-check" name="catGasto" id="catGasolina" value="Gasolina" checked><label class="btn btn-outline-warning w-100" for="catGasolina">‚õΩ Gasolina</label></div>
                        <div class="col-6"><input type="radio" class="btn-check" name="catGasto" id="catComida" value="Comida"><label class="btn btn-outline-success w-100" for="catComida">üçî Comida</label></div>
                        <div class="col-6"><input type="radio" class="btn-check" name="catGasto" id="catTaller" value="Mec√°nica"><label class="btn btn-outline-secondary w-100" for="catTaller">üõ†Ô∏è Taller</label></div>
                        <div class="col-6"><input type="radio" class="btn-check" name="catGasto" id="catOtro" value="Otros"><label class="btn btn-outline-light w-100" for="catOtro">üìù Otro</label></div>
                    </div>
                    <input type="text" id="notaGastoRapido" class="form-control bg-dark text-white border-secondary form-control-sm mb-3" placeholder="Nota opcional">
                    <button class="btn btn-danger w-100 fw-bold" onclick="enviarGastoRapido()">REGISTRAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalTransferencia" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-info">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-info"><i class="fas fa-exchange-alt me-2"></i>Mover Dinero</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="divRecordatorioReparto" class="bg-black border border-info rounded p-2 mb-3 d-none">
                        <div class="row text-center small">
                            <div class="col-3">SUELDO<br><span id="recSueldo" class="text-white">0</span></div>
                            <div class="col-3">ARCA<br><span id="recArca" class="text-warning">0</span></div>
                            <div class="col-3">DEUDA<br><span id="recDeuda" class="text-danger">0</span></div>
                            <div class="col-3">TALLER<br><span id="recTaller" class="text-white">0</span></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted">Origen</label>
                        <select class="form-select bg-dark text-white border-secondary" id="selectOrigen" onchange="actualizarSaldoOrigen()"></select>
                        <div class="text-end"><small class="text-muted">Disponible: <span id="lblSaldoDisponible" class="text-success fw-bold">...</span></small></div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted">Destino</label>
                        <select class="form-select bg-dark text-white border-secondary" id="selectDestino"></select>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Monto</label>
                        <input type="number" id="montoTransferencia" class="form-control bg-black text-white fw-bold text-center" placeholder="0.00">
                    </div>
                    <input type="text" id="notaTransferencia" class="form-control bg-dark text-white border-secondary form-control-sm" placeholder="Nota">
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-info w-100 fw-bold" onclick="realizarTransferencia()">CONFIRMAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalBilletera" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white border-warning">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning">Mis Finanzas</h5>
                    <div class="d-flex gap-3">
                        <button class="btn btn-link text-secondary p-0" onclick="abrirGestionCuentas()"><i class="fas fa-cog fa-lg"></i></button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="card bg-success text-white mb-3 text-center">
                        <div class="card-body">
                            <h6 class="opacity-75">FONDO AHORRO (ARCA)</h6>
                            <h2 class="display-4 fw-bold" id="txtAhorro">S/ 0.00</h2>
                        </div>
                    </div>
                    <div class="row text-center mb-3">
                        <div class="col-6 border-end border-secondary">
                            <small class="text-muted">Efectivo</small><br>
                            <span class="h5" id="txtEfectivo">S/ 0.00</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Yape</small><br>
                            <span class="h5" id="txtYape">S/ 0.00</span>
                        </div>
                    </div>
                    <div class="bg-secondary bg-opacity-10 p-3 rounded mb-3">
                        <div class="d-flex justify-content-between mb-1"><span class="text-info">Taller</span><span id="txtWardaTaller">0.00</span></div>
                        <div class="d-flex justify-content-between mb-1"><span class="text-danger">Deuda</span><span id="txtWardaDeuda">0.00</span></div>
                        <div class="d-flex justify-content-between"><span class="text-warning">Emergencia</span><span id="txtWardaEmergencia">0.00</span></div>
                    </div>
                    <button class="btn btn-outline-primary w-100 mb-3" onclick="abrirModalTransferencia()">Mover Dinero</button>
                    <hr class="border-secondary">
                    <h6 class="text-muted">√öltimos Movimientos</h6>
                    <div id="listaMovimientos" class="mb-3" style="max-height: 200px; overflow-y: auto;"></div>
                    <div class="btn-group w-100 mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="abrirBilletera('hoy')">Hoy</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="abrirBilletera('semana')">Semana</button>
                        <button class="btn btn-outline-secondary btn-sm active" onclick="abrirBilletera('mes')">Mes</button>
                    </div>
                    <div style="height: 200px;"><canvas id="graficoApps"></canvas></div>
                    <div style="height: 180px; margin-top:20px;"><canvas id="graficoSemana"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEstadisticas" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-info">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-info">An√°lisis Gastos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-2 overflow-auto mb-3">
                        <button class="btn btn-sm btn-outline-light" onclick="filtrarEstadisticas('semana')">7 D√≠as</button>
                        <button class="btn btn-sm btn-outline-info active" onclick="filtrarEstadisticas('mes')">Mes</button>
                        <button class="btn btn-sm btn-outline-light" onclick="filtrarEstadisticas('anio')">A√±o</button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-5"><input type="date" id="filtroDesde" class="form-control form-control-sm bg-dark text-white border-secondary"></div>
                        <div class="col-5"><input type="date" id="filtroHasta" class="form-control form-control-sm bg-dark text-white border-secondary"></div>
                        <div class="col-2"><button class="btn btn-sm btn-info w-100" onclick="aplicarFiltroManual()"><i class="fas fa-search"></i></button></div>
                    </div>
                    <div style="height: 300px;"><canvas id="graficoGastos"></canvas></div>
                    <div class="text-center small text-muted mt-2" id="lblRangoInfo">...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCierreCaja" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning">Cierre de Turno</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="paso1_conteo" class="p-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between text-muted small"><span>Sistema Efectivo:</span><span id="lblSysEfectivo">0.00</span></div>
                            <input type="number" id="inputRealEfectivo" class="form-control bg-black text-white fw-bold text-center" placeholder="Real Efectivo">
                        </div>
                        <div class="mb-4">
                            <div class="d-flex justify-content-between text-muted small"><span>Sistema Yape:</span><span id="lblSysYape">0.00</span></div>
                            <input type="number" id="inputRealYape" class="form-control bg-black text-white fw-bold text-center" placeholder="Real Yape">
                        </div>
                        <button class="btn btn-warning w-100 fw-bold" onclick="verificarCierre()">VERIFICAR</button>
                    </div>
                    <div id="paso2_resultado" class="d-none text-center p-4">
                        <div id="iconoResultado" class="display-1 mb-3"></div>
                        <h2 id="tituloResultado"></h2>
                        <p id="mensajeResultado" class="text-muted"></p>
                        <button class="btn btn-success w-100 mb-2" onclick="procesarAjusteYReparto()">CONFIRMAR</button>
                        <button class="btn btn-outline-light w-100" onclick="reiniciarCierre()">Recontar</button>
                    </div>
                    <div id="paso3_reparto" class="d-none p-3">
                        <div class="bg-black border border-warning rounded p-2 text-center mb-3">
                            <small class="text-muted">A REPARTIR (GANANCIA)</small>
                            <h1 class="text-white m-0" id="montoFinalReparto">S/ 0.00</h1>
                        </div>
                        <div class="row text-center mb-3">
                            <div class="col-4">SUELDO<br><span id="sugPersonal">0</span></div>
                            <div class="col-4">ARCA<br><span id="sugArca">0</span></div>
                            <div class="col-4">NEGOCIO<br><span id="sugNegocioTotal">0</span></div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-info" onclick="irATransferirConDatos()">Repartir a Wardas</button>
                            <button class="btn btn-outline-light" data-bs-dismiss="modal">Finalizar</button>
                        </div>
                        <div class="d-none"><span id="resTotalMano"></span><span id="resBaseAyer"></span><span id="resGananciaHoy"></span><span id="detComida"></span><span id="detDeuda"></span><span id="detTaller"></span><span id="detGasolina"></span><span id="saldoRemanente"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalObligaciones" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white border-info">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-info">Cuentas por Pagar</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="d-flex justify-content-between p-3 bg-dark border-bottom border-secondary">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="chkVerTodos" onchange="cargarObligaciones()">
                            <label class="form-check-label small" for="chkVerTodos">Futuros</label>
                        </div>
                        <button class="btn btn-sm btn-outline-info" onclick="abrirModalContratos()">Mis Contratos</button>
                    </div>
                    <div id="listaObligaciones" class="list-group list-group-flush mb-3"></div>
                    <div class="p-3 bg-secondary bg-opacity-10 border-top border-secondary">
                        <h6 class="mb-3">Agregar Recordatorio</h6>
                        <div class="row g-2">
                            <div class="col-7"><input type="text" id="nuevaObliTitulo" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Concepto"></div>
                            <div class="col-5"><input type="number" id="nuevaObliMonto" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Monto"></div>
                            <div class="col-6"><input type="date" id="nuevaObliFecha" class="form-control form-control-sm bg-dark text-white border-secondary"></div>
                            <div class="col-6"><select id="nuevaObliPrioridad" class="form-select form-select-sm bg-dark text-white border-secondary"><option value="NORMAL">Normal</option><option value="URGENTE">Urgente</option></select></div>
                            <div class="col-12"><button class="btn btn-sm btn-success w-100" onclick="crearObligacion()">GUARDAR</button></div>
                        </div>
                    </div>
                    <div class="p-3 bg-dark border-top border-secondary">
                        <h6 class="text-warning mb-2">Registrar Pr√©stamo/Servicio</h6>
                        <div class="btn-group w-100 mb-2">
                            <input type="radio" class="btn-check" name="tipoCompromiso" id="tipoPrestamo" value="PRESTAMO" checked onclick="toggleTipoCompromiso()"><label class="btn btn-outline-secondary btn-sm" for="tipoPrestamo">Pr√©stamo</label>
                            <input type="radio" class="btn-check" name="tipoCompromiso" id="tipoServicio" value="SERVICIO" onclick="toggleTipoCompromiso()"><label class="btn btn-outline-secondary btn-sm" for="tipoServicio">Servicio</label>
                        </div>
                        <div class="row g-2">
                            <div class="col-8"><input type="text" id="presTitulo" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="T√≠tulo"></div>
                            <div class="col-4"><input type="number" id="presMonto" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="Monto"></div>
                            <div class="col-6"><input type="number" id="presCuotas" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="Cuotas"></div>
                            <div class="col-6"><input type="number" id="presDia" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="D√≠a Pago"></div>
                            <div class="col-12"><button class="btn btn-sm btn-outline-warning w-100" onclick="crearPrestamo()">GENERAR</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalContratos" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Mis Suscripciones</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="listaContratos" class="list-group list-group-flush"></div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Volver</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalMetaDiaria" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-white border-warning">
                <div class="modal-header border-secondary pb-2"><h5 class="modal-title text-warning">Objetivo Hoy</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <div class="input-group input-group-lg mb-3"><span class="input-group-text bg-black text-warning border-secondary">S/</span><input type="number" id="inputMetaDiaria" class="form-control bg-black text-white fw-bold text-center fs-1"></div>
                    <div class="row g-2 mb-3">
                        <div class="col-4"><button class="btn btn-outline-secondary w-100" onclick="setMetaRapida(150)">150</button></div>
                        <div class="col-4"><button class="btn btn-outline-warning w-100" onclick="setMetaRapida(200)">200</button></div>
                        <div class="col-4"><button class="btn btn-outline-success w-100" onclick="setMetaRapida(250)">250</button></div>
                    </div>
                    <button class="btn btn-warning w-100 fw-bold" onclick="guardarNuevaMeta()">FIJAR META</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditarMeta" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-white border-info">
                <div class="modal-body text-center">
                    <input type="hidden" id="hdnCuentaIdMeta">
                    <h6 class="text-white fw-bold text-uppercase mb-3" id="lblNombreCuentaMeta">...</h6>
                    <input type="number" id="inputNuevaMeta" class="form-control bg-black text-white fw-bold text-center fs-2 mb-3" placeholder="0">
                    <button class="btn btn-info w-100 fw-bold" onclick="guardarMetaEditada()">ACTUALIZAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGestionCuentas" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary"><h5 class="modal-title">Mis Cuentas</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-0">
                    <div id="listaCuentasAdmin" class="list-group list-group-flush"></div>
                    <div class="p-3 bg-secondary bg-opacity-10 border-top border-secondary">
                        <h6 class="text-info small mb-2">Agregar Cuenta</h6>
                        <div class="input-group mb-2">
                            <select id="newTipoCuenta" class="form-select form-select-sm bg-dark text-white border-secondary" style="max-width: 100px;"><option value="WARDA">Warda</option><option value="BANCO">Banco</option><option value="EFECTIVO">Efectivo</option></select>
                            <input type="text" id="newNombreCuenta" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Nombre">
                            <button class="btn btn-sm btn-info" onclick="guardarCuenta(null)">Crear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalMapa" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white border-warning">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning">Ruta</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="mapaLeaflet" style="height: 400px; width: 100%;"></div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConfigAuto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-light">
                <div class="modal-header border-secondary"><h5 class="modal-title">Documentos Auto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-2"><label class="text-info">SOAT</label><input type="date" id="inputSoat" class="form-control bg-dark text-white border-secondary"></div>
                    <div class="mb-2"><label class="text-warning">Revisi√≥n</label><input type="date" id="inputRevision" class="form-control bg-dark text-white border-secondary"></div>
                    <div class="mb-2"><label class="text-success">GNV</label><input type="date" id="inputGnv" class="form-control bg-dark text-white border-secondary"></div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-success w-100" onclick="guardarDocumentos()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetalleMantenimiento" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="fas fa-tools text-warning me-2"></i>Mantenimiento Tucson</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-dark d-flex align-items-center p-2 mb-3">
                        <i class="fas fa-info-circle text-info me-3 fs-4"></i>
                        <div class="small lh-1">
                            Tu auto usa <strong>cadena de distribuci√≥n</strong>. Revisa ruidos a los 200k km.
                        </div>
                    </div>
                    <div id="listaMantenimientosContainer" class="d-flex flex-column gap-3">
                        <div class="text-center text-muted">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/modules/graficos.js"></script>
    <script src="js/modules/finanzas.js"></script>
    <script src="js/modules/gestion.js"></script>
    <script src="js/modules/mapa_viaje.js"></script>
    <script src="js/main.js"></script>

</body>
</html>