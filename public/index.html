<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxiManager V3</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/styles.css">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png"> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registrado', reg))
                    .catch(err => console.log('Error SW:', err));
            });
        }
    </script>
</head>
<body class="bg-black text-white">

    <nav class="navbar navbar-dark bg-black mb-3 border-bottom border-secondary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-taxi text-warning"></i> TaxiManager</span>
            
            <div>
                <button class="btn btn-sm btn-outline-info me-2" onclick="abrirEstadisticas()">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning me-1" onclick="abrirBilletera()">
                    <i class="fas fa-wallet"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="cerrarSesion()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mb-3">
        <div class="card border-0 shadow-lg mb-3" 
             style="background: linear-gradient(135deg, #1a1a1a 0%, #2d3436 100%); cursor: pointer;" 
             onclick="cambiarMeta()">
            
            <div class="card-body p-4 position-relative overflow-hidden">
                
                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255, 193, 7, 0.1); border-radius: 50%;"></div>

                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="text-muted text-uppercase small">
                        <i class="fas fa-tachometer-alt me-1 text-warning"></i> Meta Diaria
                    </div>
                    <div class="badge bg-dark border border-secondary text-warning" id="lblPorcentaje">0%</div>
                </div>

                <h1 class="display-2 fw-bold text-white mb-0" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                    <span class="fs-4 text-secondary align-middle">S/</span><span id="lblTotalDia">0.00</span>
                </h1>
                
                <div class="progress mt-3 bg-black" style="height: 8px; border-radius: 4px;">
                    <div id="barraMeta" class="progress-bar bg-warning" role="progressbar" style="width: 0%; transition: width 1s ease-in-out;"></div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-secondary" style="font-size: 0.75rem;" id="lblMetaNum">Meta: S/ 200</small>
                    <small class="text-white fst-italic fw-bold" style="font-size: 0.75rem;" id="lblFrase">¬°A encender motores! üöï</small>
                </div>
            </div>
        </div>

        <div class="card bg-dark text-white border-secondary mb-3 shadow">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center py-2">
                <h6 class="mb-0 text-white"><i class="fas fa-car me-2"></i>Mi Auto</h6>
                <button class="btn btn-sm btn-outline-light py-0" onclick="configurarAuto()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            <div class="card-body p-3">
                
                <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist" style="font-size: 0.85rem;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active py-1" id="pills-mecanica-tab" data-bs-toggle="pill" data-bs-target="#pills-mecanica" type="button">üõ†Ô∏è Mec√°nica</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link py-1" id="pills-legal-tab" data-bs-toggle="pill" data-bs-target="#pills-legal" type="button">‚öñÔ∏è Legal</button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    
                    <div class="tab-pane fade show active" id="pills-mecanica">
                        
                        <div class="text-center mb-3">
                            <div class="text-muted small text-uppercase" style="letter-spacing: 1px;">Kilometraje Actual</div>
                            <div class="d-flex justify-content-center align-items-baseline text-white">
                                <i class="fas fa-tachometer-alt me-2 text-info opacity-50"></i>
                                <span id="lblOdometro" class="fw-bold display-6">0</span> 
                                <span class="fs-5 ms-1 text-muted">km</span>
                            </div>
                        </div>

                        <div class="d-flex gap-2 justify-content-center mb-3">
                            <button class="btn btn-sm btn-outline-info w-50" onclick="actualizarOdometro()">
                                <i class="fas fa-edit me-1"></i> Corregir Km
                            </button>
                            <button class="btn btn-sm btn-outline-warning w-50" onclick="registrarMantenimiento()">
                                <i class="fas fa-oil-can me-1"></i> Cambio Aceite
                            </button>
                        </div>

                        <div class="position-relative mb-2 mt-3">
                            <div class="progress bg-black" style="height: 25px; border-radius: 12px; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);">
                                <div id="barraAceite" class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                    role="progressbar" style="width: 100%"></div>
                            </div>
                            <div class="position-absolute top-0 start-0 w-100 text-center text-white fw-bold d-flex align-items-center justify-content-center h-100" 
                                style="font-size: 0.85rem; text-shadow: 1px 1px 3px black;">
                                Vida Aceite: <span id="lblPorcentajeAceite" class="ms-1">100%</span>
                            </div>
                        </div>
                        
                        <div class="text-end small text-muted">
                            Siguiente cambio: <span id="lblProximoCambio" class="text-white">0</span> km
                        </div>

                        <div id="lblAlertaAceite" class="alert alert-danger p-2 mb-0 mt-2 text-center small fw-bold shadow-sm" style="display: none;">
                            <i class="fas fa-exclamation-triangle blink me-1"></i> ¬°CAMBIO URGENTE REQUERIDO!
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pills-legal">
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary pb-2">
                            <div>
                                <div class="small fw-bold text-white"><i class="fas fa-shield-alt text-success me-2"></i>SOAT</div>
                                <div class="small text-muted" style="font-size: 0.75rem;" id="fechaSoat">--/--/--</div>
                            </div>
                            <div class="badge bg-secondary rounded-pill px-3" id="badgeSoat">Cargando...</div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary pb-2">
                            <div>
                                <div class="small fw-bold text-white"><i class="fas fa-search text-warning me-2"></i>Rev. T√©cnica</div>
                                <div class="small text-muted" style="font-size: 0.75rem;" id="fechaRevision">--/--/--</div>
                            </div>
                            <div class="badge bg-secondary rounded-pill px-3" id="badgeRevision">Cargando...</div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <div class="small fw-bold text-white"><i class="fas fa-gas-pump text-info me-2"></i>Chip GNV</div>
                                <div class="small text-muted" style="font-size: 0.75rem;" id="fechaGnv">--/--/--</div>
                            </div>
                            <div class="badge bg-secondary rounded-pill px-3" id="badgeGnv">Cargando...</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="modal fade" id="modalConfigAuto" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark text-white border-light">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">üìÇ Documentos del Auto</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formDocs">
                            <div class="mb-3">
                                <label class="form-label text-info">Vencimiento SOAT</label>
                                <input type="date" id="inputSoat" class="form-control bg-dark text-white border-secondary">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-warning">Vencimiento Rev. T√©cnica</label>
                                <input type="date" id="inputRevision" class="form-control bg-dark text-white border-secondary">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-success">Vencimiento GNV (Anual)</label>
                                <input type="date" id="inputGnv" class="form-control bg-dark text-white border-secondary">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-success w-100" onclick="guardarDocumentos()">
                            <i class="fas fa-save me-2"></i> Guardar Fechas
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-6">
                <button class="btn btn-warning w-100 fw-bold h-100 py-3 shadow-sm" onclick="abrirCierreCaja()">
                    <i class="fas fa-cash-register d-block mb-1 fa-lg"></i> Cierre y Reparto
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-dark border-secondary w-100 fw-bold h-100 py-3 shadow-sm text-info" onclick="abrirObligaciones()">
                    <i class="fas fa-clipboard-list d-block mb-1 fa-lg"></i> Por Pagar
                    <span class="badge bg-danger ms-1" id="badgeDeudasCount" style="display:none">0</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">

        <div class="d-grid gap-3 mb-4">
            
            <div id="selectorApps" class="mb-3">
                <label class="text-muted small mb-2">¬øDe d√≥nde sali√≥ el pasajero?</label>
                <div class="row g-2 mb-3">
                    <div class="col-3">
                        <input type="radio" class="btn-check" name="appOrigen" id="appCalle" value="CALLE" checked>
                        <label class="btn btn-outline-warning w-100 h-100 py-3" for="appCalle">
                            <i class="fas fa-hand-paper"></i><br><small>Calle</small>
                        </label>
                    </div>
                    <div class="col-3">
                        <input type="radio" class="btn-check" name="appOrigen" id="appIndriver" value="INDRIVER">
                        <label class="btn btn-outline-success w-100 h-100 py-3" for="appIndriver">
                            <i class="fas fa-car-side"></i><br><small>InDrive</small>
                        </label>
                    </div>
                    <div class="col-3">
                        <input type="radio" class="btn-check" name="appOrigen" id="appUber" value="UBER">
                        <label class="btn btn-outline-light w-100 h-100 py-3" for="appUber">
                            <i class="fab fa-uber"></i><br><small>Uber</small>
                        </label>
                    </div>
                    <div class="col-3">
                        <input type="radio" class="btn-check" name="appOrigen" id="appOtros" value="OTROS">
                        <label class="btn btn-outline-secondary w-100 h-100 py-3" for="appOtros">
                            <i class="fas fa-mobile-alt"></i><br><small>Otros</small>
                        </label>
                    </div>
                </div>
                <div id="infoDireccionAuto" class="text-info small fst-italic d-none">
                    <i class="fas fa-satellite-dish fa-spin me-1"></i> Detectando direcci√≥n...
                </div>
            </div>

            <button id="btnIniciar" class="btn btn-success btn-lg fw-bold shadow" onclick="iniciarCarrera()">
                <i class="fas fa-play mb-2"></i> INICIAR CARRERA
            </button>

            <div id="panelEnCarrera" class="d-none d-grid gap-3">
                <div class="alert alert-primary text-center m-0 border-0">
                    <i class="fas fa-satellite-dish fa-spin me-2"></i> <span id="txtCronometro">Grabando Ruta GPS...</span>
                </div>
                
                <div class="row g-2">
                    <div class="col-6">
                         <button class="btn btn-secondary btn-lg w-100" onclick="registrarParada()">
                            <i class="fas fa-map-marker-alt"></i><br>Parada
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-info btn-lg w-100" onclick="alert('Abre Waze manualmente')">
                            <i class="fas fa-location-arrow"></i><br>Waze
                        </button>
                    </div>
                </div>

                <button class="btn btn-danger btn-lg fw-bold shadow" data-bs-toggle="modal" data-bs-target="#modalCobrar">
                    <i class="fas fa-stop-circle me-2"></i> TERMINAR Y COBRAR
                </button>
            </div>
        </div>
        
        <div class="row g-3">
            <div class="row g-2 mt-2 mb-4">
                <div class="col-12">
                    <button class="btn btn-outline-danger w-100 py-3 border-dashed" data-bs-toggle="modal" data-bs-target="#modalGasto">
                        <i class="fas fa-gas-pump me-2"></i> Registrar Salida de Dinero
                    </button>
                </div>
            </div>

            <div class="mt-2 mb-5">
                <div class="d-flex justify-content-between align-items-center border-bottom border-secondary pb-2 mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <h6 class="text-muted text-uppercase small m-0"><i class="fas fa-history"></i> Historial</h6>
                        <button onclick="descargarExcel()" class="btn btn-outline-success btn-sm py-0 px-2" style="font-size: 0.7rem;">
                            <i class="fas fa-file-excel"></i> CSV
                        </button>
                    </div>
                    <input type="date" id="filtroFechaHistorial" class="form-control form-control-sm bg-dark text-white border-secondary" style="width: 130px;" onchange="cargarHistorial()">
                </div>
                <div id="listaHistorial" class="d-grid gap-2">
                    </div>
                
                <div id="msgVacio" class="text-center text-muted mt-3 d-none">
                    <small>No se encontraron carreras en esta fecha.</small>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalCobrar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Finalizar Carrera</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label text-muted small">Monto Total (S/.)</label>
                    <input type="number" class="form-control form-control-lg mb-4 bg-black text-white border-success fw-bold text-center" placeholder="0.00">

                    <label class="form-label text-muted small">M√©todo de Pago</label>
                    <div class="btn-group w-100 mb-3" role="group">
                        <input type="radio" class="btn-check" name="pago" id="pago1" checked>
                        <label class="btn btn-outline-success py-3" for="pago1">
                            <i class="fas fa-money-bill-wave"></i> Efectivo
                        </label>

                        <input type="radio" class="btn-check" name="pago" id="pago2">
                        <label class="btn btn-outline-warning py-3" for="pago2">
                            <i class="fas fa-qrcode"></i> Yape / Plin
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-success w-100 btn-lg fw-bold" onclick="guardarCarrera()">
                        <i class="fas fa-check-circle me-2"></i> REGISTRAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalGasto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-danger">
                
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger"><i class="fas fa-minus-circle me-2"></i>Registrar Salida</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    
                    <div class="mb-3">
                        <label class="form-label text-white-50 small">Selecciona Categor√≠a:</label>
                        <div class="row g-2" id="selectorCategoria">
                            
                            <div class="col-4">
                                <input type="radio" class="btn-check" name="catGasto" id="catCombustible" value="Combustible" checked>
                                <label class="btn btn-outline-secondary w-100 d-flex flex-column align-items-center py-2" for="catCombustible">
                                    <i class="fas fa-gas-pump fa-2x mb-1 text-danger"></i>
                                    <span style="font-size: 0.7rem;">GLP/GNV</span>
                                </label>
                            </div>

                            <div class="col-4">
                                <input type="radio" class="btn-check" name="catGasto" id="catAlimentos" value="Alimentos">
                                <label class="btn btn-outline-secondary w-100 d-flex flex-column align-items-center py-2" for="catAlimentos">
                                    <i class="fas fa-utensils fa-2x mb-1 text-warning"></i>
                                    <span style="font-size: 0.7rem;">Men√∫</span>
                                </label>
                            </div>

                            <div class="col-4">
                                <input type="radio" class="btn-check" name="catGasto" id="catMantenimiento" value="Mantenimiento">
                                <label class="btn btn-outline-secondary w-100 d-flex flex-column align-items-center py-2" for="catMantenimiento">
                                    <i class="fas fa-tools fa-2x mb-1 text-info"></i>
                                    <span style="font-size: 0.7rem;">Taller</span>
                                </label>
                            </div>

                            <div class="col-4">
                                <input type="radio" class="btn-check" name="catGasto" id="catLimpieza" value="Limpieza">
                                <label class="btn btn-outline-secondary w-100 d-flex flex-column align-items-center py-2" for="catLimpieza">
                                    <i class="fas fa-soap fa-2x mb-1 text-primary"></i>
                                    <span style="font-size: 0.7rem;">Lavado</span>
                                </label>
                            </div>

                            <div class="col-8">
                                <input type="radio" class="btn-check" name="catGasto" id="catOtros" value="Otros">
                                <label class="btn btn-outline-secondary w-100 h-100 d-flex align-items-center justify-content-center gap-2" for="catOtros">
                                    <i class="fas fa-ellipsis-h fa-lg"></i>
                                    <span style="font-size: 0.8rem;">Otro Gasto</span>
                                </label>
                            </div>

                        </div>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="number" class="form-control bg-dark text-white border-secondary fw-bold" id="montoGasto" placeholder="0.00" style="font-size: 1.2rem;">
                        <label for="montoGasto" class="text-muted">Monto (S/)</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="descGasto" placeholder="Ej: Almuerzo">
                        <label for="descGasto" class="text-muted">Detalle (Opcional)</label>
                    </div>

                    <div class="bg-secondary bg-opacity-10 p-2 rounded border border-secondary">
                        <label class="text-muted small mb-1 d-block">¬øDe d√≥nde sale el dinero?</label>
                        <select class="form-select form-select-sm bg-dark text-white border-secondary" id="cuentaGasto">
                            <option value="1">üíµ Caja Efectivo (Bolsillo)</option>
                            <option value="2">üì± Yape / Plin</option>
                        </select>
                    </div>

                </div>

                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger fw-bold px-4" onclick="guardarGasto()">
                        <i class="fas fa-save me-2"></i> REGISTRAR
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="modalTransferencia" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-info">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-info"><i class="fas fa-exchange-alt me-2"></i>Mover Dinero</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <div id="divRecordatorioReparto" class="alert alert-dark border-secondary p-2 mb-3 d-none">
                    <small class="text-warning fw-bold d-block mb-1 text-center text-uppercase">
                        <i class="fas fa-lightbulb me-1"></i> Montos Sugeridos:
                    </small>
                    <div class="d-flex justify-content-between border-bottom border-secondary pb-1 mb-1">
                        <span class="text-info small">üéì Sueldo:</span>
                        <span class="fw-bold text-white small" id="recSueldo">S/ 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between border-bottom border-secondary pb-1 mb-1">
                        <span class="text-warning small">üí∞ Arca:</span>
                        <span class="fw-bold text-white small" id="recArca">S/ 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between border-bottom border-secondary pb-1 mb-1">
                        <span class="text-danger small">üìâ Deuda:</span>
                        <span class="fw-bold text-white small" id="recDeuda">S/ 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-secondary small">üõ†Ô∏è Taller:</span>
                        <span class="fw-bold text-white small" id="recTaller">S/ 0.00</span>
                    </div>
                </div>
                <form id="formTransferencia">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Desde (Origen)</label>
                        <select class="form-select bg-dark text-white border-secondary" id="selectOrigen">
                            </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small">Hacia (Destino)</label>
                        <select class="form-select bg-dark text-white border-secondary" id="selectDestino">
                            </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white fw-bold">Monto a Mover</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-white border-secondary">S/</span>
                            <input type="number" id="montoTransferencia" class="form-control bg-black text-white border-secondary fw-bold fs-4 text-center" placeholder="0.00" step="0.10">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small">Nota (Opcional)</label>
                        <input type="text" id="notaTransferencia" class="form-control bg-dark text-white border-secondary form-control-sm" placeholder="Ej: Ahorro del d√≠a">
                    </div>
                </form>

            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-info w-100 fw-bold" onclick="realizarTransferencia()">
                    CONFIRMAR TRANSFERENCIA <i class="fas fa-check ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

    <div class="modal fade" id="modalBilletera" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white border-warning">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning"><i class="fas fa-chart-pie"></i> Mis Finanzas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="card bg-success text-white mb-3 shadow">
                        <div class="card-body text-center">
                            <h6 class="card-title text-uppercase opacity-75">Fondo Ahorro (Arca 10%)</h6>
                            <h2 class="display-4 fw-bold" id="txtAhorro">S/ 0.00</h2>
                            <small><i class="fas fa-lock me-1"></i>¬°Capital Intangible!</small>
                        </div>
                    </div>

                    <h6 class="text-muted border-bottom border-secondary pb-2 mb-3">Dinero Disponible (Bolsillo)</h6>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="fas fa-money-bill-wave text-success"></i> Efectivo</span>
                        <span class="h4 mb-0" id="txtEfectivo">S/ 0.00</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span><i class="fas fa-mobile-alt text-warning"></i> Yape / Plin</span>
                        <span class="h4 mb-0" id="txtYape">S/ 0.00</span>
                    </div>

                    <h6 class="text-muted border-bottom border-secondary pb-2 mb-3">
                        <i class="fas fa-piggy-bank"></i> Fondos Warda (Objetivos)
                    </h6>

                    <div class="bg-secondary bg-opacity-10 p-3 rounded mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-info"><i class="fas fa-tools me-2"></i>Warda Taller</span>
                            <span class="h5 mb-0 fw-bold" id="txtWardaTaller">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-danger"><i class="fas fa-university me-2"></i>Warda Deuda 8k</span>
                            <span class="h5 mb-0 fw-bold" id="txtWardaDeuda">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-warning"><i class="fas fa-first-aid me-2"></i>Warda Emergencia</span>
                            <span class="h5 mb-0 fw-bold" id="txtWardaEmergencia">S/ 0.00</span>
                        </div>
                    </div>

                    <div class="d-grid mb-4">
                        <button class="btn btn-outline-primary" onclick="abrirModalTransferencia()">
                            <i class="fas fa-exchange-alt me-2"></i> Mover Dinero / Repartir
                        </button>
                    </div>

                    <hr class="border-secondary">

                    <h6 class="text-muted border-bottom border-secondary pb-2 mb-2">
                        <i class="fas fa-list-ul"></i> √öltimos Movimientos
                    </h6>
                    
                    <div id="listaMovimientos" class="mb-4 pe-2" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted small py-3">Cargando...</div>
                    </div>
                    <div class="text-center text-danger mb-4">
                        <small>Gastos de este mes: <span id="txtGastos">S/ 0.00</span></small>
                    </div>

                    <h6 class="text-muted border-bottom border-secondary pb-2 mb-3 mt-4">
                        <i class="fas fa-chart-pie"></i> Rendimiento
                    </h6>

                    <div class="btn-group w-100 mb-3" role="group">
                        <input type="radio" class="btn-check" name="filtroGrafico" id="filtroHoy" autocomplete="off" onclick="abrirBilletera('hoy')">
                        <label class="btn btn-outline-secondary btn-sm" for="filtroHoy">Hoy</label>

                        <input type="radio" class="btn-check" name="filtroGrafico" id="filtroSemana" autocomplete="off" onclick="abrirBilletera('semana')">
                        <label class="btn btn-outline-secondary btn-sm" for="filtroSemana">Semana</label>

                        <input type="radio" class="btn-check" name="filtroGrafico" id="filtroMes" autocomplete="off" checked onclick="abrirBilletera('mes')">
                        <label class="btn btn-outline-secondary btn-sm" for="filtroMes">Mes</label>
                    </div>

                    <div style="height: 200px;">
                        <canvas id="graficoApps"></canvas>
                    </div>

                    <h6 class="text-muted border-bottom border-secondary pb-2 mb-3 mt-4">
                        <i class="fas fa-chart-bar"></i> √öltimos 7 D√≠as
                    </h6>
                    <div style="height: 180px;">
                        <canvas id="graficoSemana"></canvas>
                    </div>
                    <hr class="border-secondary my-4">

                    <div class="d-grid">
                        <button class="btn btn-success" onclick="descargarReporteFinanciero()">
                            <i class="fas fa-file-excel me-2"></i> Descargar Balance Financiero
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="modalEstadisticas" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-info">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-info"><i class="fas fa-chart-pie me-2"></i>An√°lisis de Gastos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="d-flex gap-2 mb-3 pb-2" style="overflow-x: auto; white-space: nowrap;">
                        <button class="btn btn-sm btn-outline-light" onclick="filtrarEstadisticas('hoy')">Hoy</button>
                        <button class="btn btn-sm btn-outline-light" onclick="filtrarEstadisticas('ayer')">Ayer</button>
                        <button class="btn btn-sm btn-outline-light" onclick="filtrarEstadisticas('semana')">7 D√≠as</button>
                        <button class="btn btn-sm btn-outline-info active" onclick="filtrarEstadisticas('mes')">Mes</button>
                        <button class="btn btn-sm btn-outline-light" onclick="filtrarEstadisticas('3meses')">3 Meses</button>
                        <button class="btn btn-sm btn-outline-light" onclick="filtrarEstadisticas('anio')">A√±o</button>
                    </div>

                    <div class="row g-2 mb-3 bg-secondary bg-opacity-10 p-2 rounded align-items-end">
                        <div class="col-5">
                            <label class="small text-muted">Desde</label>
                            <input type="date" id="filtroDesde" class="form-control form-control-sm bg-dark text-white border-secondary">
                        </div>
                        <div class="col-5">
                            <label class="small text-muted">Hasta</label>
                            <input type="date" id="filtroHasta" class="form-control form-control-sm bg-dark text-white border-secondary">
                        </div>
                        <div class="col-2 d-grid">
                            <button class="btn btn-sm btn-info" onclick="aplicarFiltroManual()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="graficoGastos"></canvas>
                    </div>
                    
                    <div class="mt-2 text-center small text-muted fst-italic" id="lblRangoInfo">
                        Mostrando mes actual
                    </div>

                </div>
            </div>
        </div>
    </div>




    <div class="modal fade" id="modalObligaciones" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg"> 
            <div class="modal-content bg-dark text-white border-info">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-info"><i class="fas fa-tasks me-2"></i>Cuentas por Pagar</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                
                <div class="modal-body p-0">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark border-bottom border-secondary">
                        <div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="chkVerTodos" onchange="cargarObligaciones()">
                                <label class="form-check-label text-white small" for="chkVerTodos">Ver futuros</label>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-info" onclick="abrirModalContratos()">
                            <i class="fas fa-file-contract me-1"></i> Mis Contratos
                        </button>
                    </div>
                    <div id="listaObligaciones" class="list-group list-group-flush mb-3">
                        <div class="text-center p-4 text-muted">Cargando...</div>
                    </div>

                    <div class="p-3 bg-secondary bg-opacity-10 border-top border-secondary">
                        <h6 class="text-white mb-3"><i class="fas fa-plus-circle text-success"></i> Agregar Gasto Puntual</h6>
                        
                        <div class="row g-2">
                            <div class="col-7">
                                <label class="small text-info mb-1">Concepto</label>
                                <input type="text" id="nuevaObliTitulo" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Ej: Papeleta, Luz...">
                            </div>
                            <div class="col-5">
                                <label class="small text-info mb-1">Monto (S/)</label>
                                <input type="number" id="nuevaObliMonto" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="0.00">
                            </div>
                            <div class="col-6">
                                <label class="small text-info mb-1">Vencimiento</label>
                                <input type="date" id="nuevaObliFecha" class="form-control form-control-sm bg-dark text-white border-secondary">
                            </div>
                            <div class="col-6">
                                <label class="small text-info mb-1">Prioridad</label>
                                <select id="nuevaObliPrioridad" class="form-select form-select-sm bg-dark text-white border-secondary">
                                    <option value="NORMAL">Normal</option>
                                    <option value="ALTA">Alta</option>
                                    <option value="URGENTE">üö® URGENTE</option>
                                </select>
                            </div>
                            <div class="col-12 d-grid mt-2">
                                <button class="btn btn-sm btn-success fw-bold" onclick="crearObligacion()">
                                    <i class="fas fa-save me-1"></i> GUARDAR RECORDATORIO
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 bg-dark border-top border-secondary mt-2">
                        <h6 class="text-warning mb-2"><i class="fas fa-hand-holding-usd"></i> Registrar Contrato / Servicio</h6>
                        
                        <div class="row g-2">
                            <div class="col-12 mb-2">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="tipoCompromiso" id="tipoPrestamo" value="PRESTAMO" checked onclick="toggleTipoCompromiso()">
                                    <label class="btn btn-outline-secondary btn-sm" for="tipoPrestamo">üè¶ Pr√©stamo (Finito)</label>

                                    <input type="radio" class="btn-check" name="tipoCompromiso" id="tipoServicio" value="SERVICIO" onclick="toggleTipoCompromiso()">
                                    <label class="btn btn-outline-secondary btn-sm" for="tipoServicio">üì± Servicio (Mensual)</label>
                                </div>
                            </div>

                            <div class="col-8">
                                <input type="text" id="presTitulo" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="Ej: Auto / Plan Celular">
                            </div>
                            <div class="col-4">
                                <input type="number" id="presMonto" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="Monto S/">
                            </div>
                            
                            <div class="col-6">
                                <input type="number" id="presCuotas" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="N¬∞ Cuotas">
                            </div>
                            
                            <div class="col-6">
                                <input type="number" id="presDia" class="form-control form-control-sm bg-black text-white border-secondary" placeholder="D√≠a Pago (Ej: 5)">
                            </div>

                            <div class="col-12 d-grid">
                                <button class="btn btn-sm btn-outline-warning" onclick="crearPrestamo()">
                                    <i class="fas fa-cogs me-1"></i> GENERAR CRONOGRAMA
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalContratos" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="fas fa-file-signature text-warning me-2"></i>Mis Suscripciones</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="listaContratos" class="list-group list-group-flush">
                        <div class="text-center p-3 text-muted">Cargando...</div>
                    </div>
                    
                    <div class="p-3 text-center text-muted small border-top border-secondary">
                        * Al cancelar, se borrar√°n todos los pagos futuros pendientes.
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Volver</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalMapa" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content bg-dark text-white border-warning">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning"><i class="fas fa-map-marked-alt me-2"></i>Ruta del Viaje</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="mapaLeaflet" style="height: 400px; width: 100%;"></div>
                </div>
                <div class="modal-footer border-secondary justify-content-between">
                    <small class="text-muted"><i class="fas fa-circle text-success"></i> Inicio &nbsp; <i class="fas fa-flag text-danger"></i> Fin</small>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCierreCaja" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning fw-bold"><i class="fas fa-cash-register me-2"></i>Cierre de Turno</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body p-0">
                    
                    <div id="paso1_conteo" class="p-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between text-muted small mb-1">
                                <span>üíµ Efectivo Sistema:</span>
                                <span class="text-white">S/ <span id="lblSysEfectivo">0.00</span></span>
                            </div>
                            <div class="input-group input-group-lg border border-secondary rounded">
                                <span class="input-group-text bg-black text-secondary border-0"><i class="fas fa-money-bill-wave"></i></span>
                                <input type="number" id="inputRealEfectivo" class="form-control bg-black text-white border-0 fw-bold fs-4 text-center" placeholder="0.00">
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between text-muted small mb-1">
                                <span>üì± Yape Sistema:</span>
                                <span class="text-white">S/ <span id="lblSysYape">0.00</span></span>
                            </div>
                            <div class="input-group input-group-lg border border-secondary rounded">
                                <span class="input-group-text bg-black text-secondary border-0" style="color: #d63384 !important;"><i class="fas fa-mobile-alt"></i></span>
                                <input type="number" id="inputRealYape" class="form-control bg-black text-white border-0 fw-bold fs-4 text-center" placeholder="0.00">
                            </div>
                        </div>

                        <button class="btn btn-warning w-100 fw-bold py-3 shadow" onclick="verificarCierre()">
                            VERIFICAR MONTOS <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>

                    <div id="paso2_resultado" class="d-none text-center p-4">
                        <div id="iconoResultado" class="display-1 mb-3"></div>
                        <h2 id="tituloResultado" class="fw-bold mb-2"></h2>
                        <p id="mensajeResultado" class="text-white-50 mb-4 fs-6"></p>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg fw-bold" id="btnAjustarContinuar" onclick="procesarAjusteYReparto()">
                                CONFIRMAR Y REPARTIR
                            </button>
                            <button class="btn btn-outline-light" onclick="reiniciarCierre()">Recontar</button>
                        </div>
                    </div>

                    <div id="paso3_reparto" class="d-none p-3">
                        
                        <div class="bg-black border border-secondary rounded p-2 mb-3 small">
                            <div class="d-flex justify-content-between text-muted">
                                <span>üí∞ Total en Mano:</span>
                                <span class="text-white fw-bold" id="resTotalMano">S/ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between text-muted">
                                <span>üìÖ Base Ayer:</span>
                                <span class="text-white fw-bold" id="resBaseAyer">S/ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between border-top border-secondary mt-1 pt-1">
                                <span class="text-success fw-bold">GANANCIA HOY:</span>
                                <span class="text-success fw-bold fs-6" id="resGananciaHoy">S/ 0.00</span>
                            </div>
                        </div>

                        <div class="text-center mb-3">
                            <div class="text-secondary text-uppercase small fw-bold mb-1">Monto a Repartir (Ganancia)</div>
                            <div class="bg-black border border-warning rounded p-2 shadow-sm">
                                <h1 class="fw-bold text-white mb-0" id="montoFinalReparto" style="text-shadow: 0 0 15px rgba(255,193,7,0.3);">S/ 0.00</h1>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="p-2 bg-dark border border-light rounded text-center h-100">
                                    <div style="font-size: 0.65rem;" class="text-info fw-bold mb-1">SUELDO PROPIO</div>
                                    <h4 class="fw-bold text-white mb-0" id="sugPersonal">0.00</h4>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-dark border border-warning rounded text-center h-100">
                                    <div style="font-size: 0.65rem;" class="text-warning fw-bold mb-1">ARCA ORO</div>
                                    <h4 class="fw-bold text-white mb-0" id="sugArca">0.00</h4>
                                </div>
                            </div>
                        </div>

                        <div class="card bg-secondary bg-opacity-10 border-success mb-3">
                            <div class="card-header bg-success bg-opacity-25 py-1 border-success d-flex justify-content-between align-items-center">
                                <small class="text-white fw-bold">NEGOCIO (80%)</small>
                                <span class="badge bg-success" id="sugNegocioTotal">S/ 0.00</span>
                            </div>
                            <ul class="list-group list-group-flush small">
                                <li class="list-group-item bg-transparent text-white d-flex justify-content-between py-2 border-secondary">
                                    <span><i class="fas fa-utensils text-info me-2"></i>Comida Casa</span>
                                    <span class="fw-bold text-white fs-6" id="detComida">S/ 40.00</span>
                                </li>
                                <li class="list-group-item bg-transparent text-white d-flex justify-content-between py-1 border-secondary">
                                    <span><i class="fas fa-chart-line text-danger me-2"></i>Deuda 8k</span>
                                    <span class="fw-bold text-white-50" id="detDeuda">0.00</span>
                                </li>
                                <li class="list-group-item bg-transparent text-white d-flex justify-content-between py-1 border-secondary">
                                    <span><i class="fas fa-tools text-secondary me-2"></i>Taller</span>
                                    <span class="fw-bold text-white-50" id="detTaller">0.00</span>
                                </li>
                                <li class="list-group-item bg-black text-white d-flex justify-content-between py-2 border-0">
                                    <span><i class="fas fa-gas-pump text-warning me-2"></i>Saldo Ma√±ana</span>
                                    <span class="fw-bold text-warning fs-6" id="detGasolina">0.00</span>
                                </li>
                            </ul>
                        </div>

                        <div class="bg-primary bg-opacity-25 border border-primary text-center py-2 mb-3 rounded">
                            <small class="text-white d-block mb-1 fw-bold" style="font-size: 0.7rem;">SALDO FINAL EN MANO:</small>
                            <div class="fw-bold text-white">
                                <span class="text-white fs-4" id="saldoRemanente">S/ 0.00</span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info" onclick="irATransferirConDatos()">
                                <i class="fas fa-exchange-alt me-2"></i> Mover Dinero a Wardas
                            </button>
                            <button class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">
                                Finalizar
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>

</body>
</html>